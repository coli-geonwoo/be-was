<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link href="../reset.css" rel="stylesheet" />
    <link href="../global.css" rel="stylesheet" />
  </head>
  <body>
    <div class="container">
      <header class="header">
        <a href="/"><img src="../img/signiture.svg" /></a>
        <ul class="header__menu">
        <li class="header__menu__item">
            <a class="btn btn_contained btn_size_s" href="/article">글쓰기</a>
          </li>
          <li class="header__menu__item">
            <button id="logout-btn" class="btn btn_ghost btn_size_s">
              로그아웃
            </button>
          </li>
        </ul>
      </header>
      <div class="page">
        <h2 class="page-title">마이페이지</h2>
        <div class="profile_image">
          <img id="profile-img" class="profile" src="https://avatars.githubusercontent.com/u/148152234?s=400&v=4" />
        </div>
        <div class="profile_frame">
          <div class="btn_profile">
            <label for="profile-upload" class="btn_container" style="cursor: pointer;">수정</label>
            <input type="file" id="profile-upload" accept="image/*" style="display: none;" />
          </div>
          <div class="btn_bar"></div>
          <div class="btn_profile">
            <div id="profile-delete" class="btn_container" style="cursor: pointer;">삭제</div>
          </div>
        </div>
        </div>
          <form id ="profile-form" class="form">
            <div class="textfield textfield_size_s input_margin">
              <p class="title_textfield">닉네임</p>
              <input
                id = "nickname-input"
                class="input_textfield"
                name = "nickname"
                value={{nickname}}
                autocomplete="username"
              />
            </div>
            <div class="textfield textfield_size_s">
              <p class="title_textfield">비밀번호</p>
              <input
                id ="password-input"
                class="input_textfield"
                type = "password"
                name="password"
                placeholder="비밀번호를 변경할 경우 입력해주세요"
              />
              <p id="password-error" class="error-message">비밀번호는 최소 4자 이상이어야 합니다</p>
            </div>
            <div class="textfield textfield_size_s">
              <p class="title_textfield">비밀번호 확인</p>
              <input
                id="password-confirm-input"
                class="input_textfield"
                type="password"
                name = "passwordconfirm"
                placeholder="한 번 더 입력해주세요"
              />
              <p id="password-confirm-error" class="error-message">비밀번호가 일치하지 않습니다</p>
            </div>
            <button
              id="registration-btn"
              class="btn btn_contained btn_size_m input_margin"
              type="submit"
            >
              변경사항 저장
            </button>

        </form>
      </div>
    </div>
    </div>
    <script>
      const DEFAULT_PROFILE_IMG = 'https://avatars.githubusercontent.com/u/148152234?s=400&v=4';
      let currentProfileImg = null;
      let selectedFile = null;
      let isProfileDeleted = false;

      // 페이지 로드 시 현재 프로필 정보 가져오기
      async function loadProfile() {
        try {
          const response = await fetch('/mypage');
          if (!response.ok) {
            throw new Error('프로필 정보를 불러올 수 없습니다.');
          }
          const data = await response.json();

          document.getElementById('nickname-input').value = data.nickname || '';

          if (data.profileImage) {
            currentProfileImg = data.profileImage;
            document.getElementById('profile-img').src = data.profileImage;
          } else {
            document.getElementById('profile-img').src = DEFAULT_PROFILE_IMG;
          }
        } catch (e) {
          console.error('프로필 로드 실패:', e);
        }
      }

      // 프로필 이미지 수정
      document.getElementById('profile-upload').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
          if (!file.type.startsWith('image/')) {
            alert('이미지 파일만 업로드 가능합니다.');
            return;
          }

          selectedFile = file;
          isProfileDeleted = false;

          const reader = new FileReader();
          reader.onload = (event) => {
            document.getElementById('profile-img').src = event.target.result;
          };
          reader.readAsDataURL(file);
        }
      });

      // 프로필 이미지 삭제
      document.getElementById('profile-delete').addEventListener('click', () => {
        document.getElementById('profile-img').src = DEFAULT_PROFILE_IMG;
        selectedFile = null;
        isProfileDeleted = true;
        document.getElementById('profile-upload').value = '';
      });

      // 비밀번호 유효성 검사
      function validatePassword(password) {
        if (password && password.length < 4) {
          return false;
        }
        return true;
      }

      // 비밀번호 확인
      function validatePasswordConfirm(password, passwordConfirm) {
        if (password && password !== passwordConfirm) {
          return false;
        }
        return true;
      }

      // 비밀번호 입력 시 실시간 검증
      document.getElementById('password-input').addEventListener('input', (e) => {
        const password = e.target.value;
        const errorMsg = document.getElementById('password-error');
        const input = e.target;

        if (password && !validatePassword(password)) {
          errorMsg.classList.add('show');
          input.classList.add('error');
        } else {
          errorMsg.classList.remove('show');
          input.classList.remove('error');
        }

        // 비밀번호 확인도 다시 검증
        const passwordConfirm = document.getElementById('password-confirm-input').value;
        if (passwordConfirm) {
          validatePasswordConfirmField(password, passwordConfirm);
        }
      });

      // 비밀번호 확인 입력 시 실시간 검증
      document.getElementById('password-confirm-input').addEventListener('input', (e) => {
        const password = document.getElementById('password-input').value;
        const passwordConfirm = e.target.value;
        validatePasswordConfirmField(password, passwordConfirm);
      });

      function validatePasswordConfirmField(password, passwordConfirm) {
        const errorMsg = document.getElementById('password-confirm-error');
        const input = document.getElementById('password-confirm-input');

        if (passwordConfirm && !validatePasswordConfirm(password, passwordConfirm)) {
          errorMsg.classList.add('show');
          input.classList.add('error');
        } else {
          errorMsg.classList.remove('show');
          input.classList.remove('error');
        }
      }

      // 폼 제출
      document.getElementById('profile-form').addEventListener('submit', async (e) => {
        e.preventDefault();

        const nickname = document.getElementById('nickname-input').value.trim();
        const password = document.getElementById('password-input').value;
        const passwordConfirm = document.getElementById('password-confirm-input').value;

        // 닉네임 검증
        if (!nickname) {
          alert('닉네임을 입력해주세요.');
          return;
        }

        // 비밀번호 검증
        if (password) {
          if (!validatePassword(password)) {
            alert('비밀번호는 최소 4자 이상이어야 합니다.');
            return;
          }

          if (!validatePasswordConfirm(password, passwordConfirm)) {
            alert('비밀번호가 일치하지 않습니다.');
            return;
          }
        }

        // FormData 생성
        const formData = new FormData();
        formData.append('nickname', nickname);

        if (password) {
          formData.append('password', password);
        }

        // 프로필 이미지 처리
        if (isProfileDeleted) {
          formData.append('deleteProfile', 'true');
        } else if (selectedFile) {
          formData.append('profileImage', selectedFile);
        }

        try {
          const response = await fetch('/mypage', {
            method: 'PATCH',
            body: formData
          });

          if (!response.ok) {
            const error = await response.json();
            alert(error.message || '프로필 수정에 실패했습니다.');
            return;
          }

          alert('프로필이 성공적으로 수정되었습니다.');

          // 프로필 다시 로드
          selectedFile = null;
          isProfileDeleted = false;
          document.getElementById('password-input').value = '';
          document.getElementById('password-confirm-input').value = '';
          await loadProfile();

        } catch (e) {
          alert('서버와 통신할 수 없습니다.');
          console.error('프로필 수정 실패:', e);
        }
      });

      // 로그아웃
      const logoutBtn = document.getElementById("logout-btn");
      logoutBtn.addEventListener("click", async () => {
        try {
          const response = await fetch("/logout", {
            method: "POST",
          });

          if (!response.ok) {
            alert("로그아웃에 실패했습니다.");
            return;
          }
          window.location.href = "/";
        } catch (e) {
          alert("서버와 통신할 수 없습니다.");
        }
      });

      // 페이지 로드 시 프로필 정보 가져오기
      loadProfile();
    </script>
  </body>
</html>
